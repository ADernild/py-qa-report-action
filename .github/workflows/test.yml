name: Test Action

on:
  pull_request:
    branches: [main, test]

jobs:
  test-action:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Create dummy test reports
        run: |
          cat > pytest-report.json << 'EOF'
          {
            "summary": {"total": 10, "passed": 7, "failed": 2, "skipped": 1, "error": 0},
            "duration": 3.45,
            "tests": [
              {
                "nodeid": "tests/test_example.py::test_addition",
                "outcome": "failed",
                "call": {"longrepr": "AssertionError: Expected 4 but got 5"}
              }
            ]
          }
          EOF

          cat > bandit-report.json << 'EOF'
          {
            "metrics": {"_totals": {"loc": 500}},
            "results": [
              {
                "code": "10     subprocess.run([\"ls\", \"-la\"], check=True)\n",
                "filename": "src/example.py",
                "issue_confidence": "HIGH",
                "issue_severity": "MEDIUM",
                "issue_text": "subprocess call - check for execution of untrusted input.",
                "line_number": 10,
                "line_range": [10],
                "test_id": "B603",
                "test_name": "subprocess_without_shell_equals_true"
              }
            ]
          }
          EOF

          cat > ruff-report.json << 'EOF'
          [
            {
              "cell": null,
              "code": "SIM102",
              "end_location": {
                "column": 27,
                "row": 4
              },
              "filename": "/Users/aid/repos/DevOps/api-clients/violation.py",
              "fix": {
                "applicability": "unsafe",
                "edits": [
                  {
                    "content": "    if arg and len(arg) > 1:\n        if arg[0] > 5:\n            return arg",
                    "end_location": {
                      "column": 27,
                      "row": 5
                    },
                    "location": {
                      "column": 1,
                      "row": 2
                    }
                  }
                ],
                "message": "Combine `if` statements using `and`"
              },
              "location": {
                "column": 5,
                "row": 2
              },
              "message": "Use a single `if` statement instead of nested `if` statements",
              "noqa_row": 2,
              "url": "https://docs.astral.sh/ruff/rules/collapsible-if"
            },
            {
              "cell": null,
              "code": "SIM102",
              "end_location": {
                "column": 27,
                "row": 4
              },
              "filename": "/Users/aid/repos/DevOps/api-clients/violation.py",
              "fix": {
                "applicability": "unsafe",
                "edits": [
                  {
                    "content": "        if len(arg) > 1 and arg[0] > 5:\n            return arg",
                    "end_location": {
                      "column": 27,
                      "row": 5
                    },
                    "location": {
                      "column": 1,
                      "row": 3
                    }
                  }
                ],
                "message": "Combine `if` statements using `and`"
              },
              "location": {
                "column": 9,
                "row": 3
              },
              "message": "Use a single `if` statement instead of nested `if` statements",
              "noqa_row": 3,
              "url": "https://docs.astral.sh/ruff/rules/collapsible-if"
            }
          ]
          EOF

      - name: Test Action
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          pytest-results: pytest-report.json
          bandit-results: bandit-report.json
          ruff-results: ruff-report.json
          fail-on-errors: true
          update-comment: true
